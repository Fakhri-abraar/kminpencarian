{% extends "base.html" %}

{% block title %}Search - Zenith{% endblock %}

{% block content %}
<style>
    .search-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .search-form {
        flex-grow: 1;
        display: flex;
        gap: 1rem;
    }

    .search-input {
        flex-grow: 1;
        padding: 1rem 1.5rem;
        background-color: var(--subtle-bg-dark-violet);
        border: 2px solid var(--border-gray-purple);
        border-radius: 10px;
        color: var(--heading-white);
        font-family: 'Open Sans', sans-serif;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-violet);
        box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1);
    }

    .search-input::placeholder {
        color: var(--body-white);
        opacity: 0.5;
    }

    .search-btn {
        padding: 1rem 2.5rem;
        background-color: var(--primary-violet);
        color: var(--smooth-black);
        border: 2px solid var(--primary-violet);
        border-radius: 10px;
        font-family: 'Exo 2', sans-serif;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .search-btn:hover {
        background-color: transparent;
        color: var(--primary-violet);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(167, 139, 250, 0.4);
    }

    .user-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .user-card {
        background-color: var(--subtle-bg-dark-violet);
        border: 2px solid var(--border-gray-purple);
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        transition: all 0.3s ease;
    }

    .user-card:hover {
        border-color: var(--primary-violet);
        transform: translateY(-2px);
    }

    .user-avatar {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-violet), var(--border-gray-purple));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: var(--heading-white);
        font-weight: 700;
        flex-shrink: 0;
    }

    .user-info {
        flex-grow: 1;
    }

    .user-name {
        font-family: 'Exo 2', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--heading-white);
        margin: 0;
    }

    .no-results {
        text-align: center;
        padding: 3rem;
        color: var(--body-white);
        font-size: 1.125rem;
    }

    @media (max-width: 768px) {
        .search-header {
            flex-direction: column;
        }

        .search-form {
            width: 100%;
            flex-direction: column;
        }

        .search-btn {
            width: 100%;
        }

        .user-card {
            flex-direction: column;
            text-align: center;
        }
    }
</style>

<div class="search-header">
    <form method="POST" action="{{ url_for('main.search_user') }}" class="search-form">
        <input type="text" name="username" placeholder="Search Bar" required 
               class="search-input" value="{{ search_query }}">
        <button type="submit" class="search-btn">Search</button>
    </form>
</div>

<div class="user-list">
    {% if users %}
        {% for user in users %}
        <a href="{{ url_for('files.view_user_files', username=user.username) }}" class="user-card" style="text-decoration: none; cursor: pointer;">
            <div class="user-avatar">
                {{ user.username[0].upper() }}
            </div>
            <div class="user-info">
                <h3 class="user-name">{{ user.username }}</h3>
            </div>
        </a>
        {% endfor %}
    {% elif search_query %}
        <div class="no-results">
            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>No users found matching "{{ search_query }}"</p>
        </div>
    {% else %}
        <div class="no-results">
            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>Enter a username to search</p>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update connection controls for each user card
    document.querySelectorAll('.connection-controls').forEach(control => {
        const userId = control.dataset.userId;
        
    fetch(`/connections/check-status/${userId}`)
            .then(response => response.json())
            .then(data => {
                let html = '';
                
                if (data.status === 'none') {
                    // Use JS template interpolation to build the correct action URL
                    html = `
                        <form action="/connections/request/${userId}" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-primary connection-btn">
                                <i class="fas fa-user-plus"></i> Connect
                            </button>
                        </form>
                    `;
                } else if (data.status === 'pending') {
                    if (data.is_requester) {
                        html = `
                            <button class="btn btn-secondary connection-btn" disabled>
                                <i class="fas fa-clock"></i> Request Sent
                            </button>
                        `;
                    } else {
                        html = `
                            <div class="btn-group">
                                <form action="/connections/respond/${data.connection_id}/accept" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-success connection-btn">
                                        <i class="fas fa-check"></i> Accept
                                    </button>
                                </form>
                                <form action="/connections/respond/${data.connection_id}/reject" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-danger connection-btn">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </form>
                            </div>
                        `;
                    }
                } else if (data.status === 'accepted') {
                    html = `
                        <form action="/connections/remove/${userId}" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-outline-danger connection-btn" onclick="return confirm('Are you sure you want to remove this connection?');">
                                <i class="fas fa-user-minus"></i> Disconnect
                            </button>
                        </form>
                    `;
                }
                
                control.innerHTML = html;
            })
            .catch(error => console.error('Error:', error));
    });
});
</script>
{% endblock %}